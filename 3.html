<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rico.bet VIP Expert Missions</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #ffd166; --dark: #0b0604; --neon: #22d3ee; --paper: #f2e3c9; }
        body { background: var(--dark); color: white; font-family: 'Orbitron', sans-serif; margin: 0; display: flex; justify-content: center; }
        
        .game-wrap { max-width: 450px; width: 100%; margin: 20px auto; padding: 20px; border: 2px solid var(--gold); border-radius: 20px; background: #111; min-height: 600px; display: flex; flex-direction: column; }
        .mission { display: none; flex-direction: column; align-items: center; flex: 1; }
        .active { display: flex; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h1 { font-family: 'Cinzel'; color: var(--gold); font-size: 1.3rem; text-shadow: 0 0 10px rgba(255,209,102,0.3); margin-bottom: 5px; }
        .desc { font-size: 0.8rem; color: #888; margin-bottom: 20px; text-align: center; }

        /* Slot Counter UI */
        .slot-tracker { background: rgba(255, 209, 102, 0.1); border: 1px solid var(--gold); border-radius: 10px; padding: 10px; width: 100%; margin-bottom: 15px; text-align: center; }
        .progress-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--gold); transition: width 0.5s; }

        /* M1: Thermal Search */
        #scanner-box { position: relative; width: 100%; height: 350px; background: #000; border-radius: 15px; overflow: hidden; cursor: none; border: 1px solid #333; }
        #torch { position: absolute; width: 140px; height: 140px; background: radial-gradient(circle, rgba(255,209,102,0.25) 0%, transparent 70%); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 10; }
        .mascot-target { position: absolute; opacity: 0; transition: opacity 0.3s; cursor: pointer; }
        .mascot-target.found { opacity: 1 !important; filter: drop-shadow(0 0 10px var(--gold)); pointer-events: none; }

        /* M2: Pipe Logic */
        .pipe-grid { display: grid; grid-template-columns: repeat(4, 80px); gap: 10px; padding: 15px; background: #050505; border-radius: 10px; border: 1px solid #222; }
        .pipe-cell { width: 80px; height: 80px; background: #1a1a1a; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: 0.2s; border: 1px solid #333; }
        .pipe-svg { width: 70%; height: 70%; stroke: #444; stroke-width: 12; fill: none; transition: 0.4s; stroke-linecap: round; }
        .active-pipe .pipe-svg { stroke: var(--neon); filter: drop-shadow(0 0 8px var(--neon)); }
        .entry, .exit { position: absolute; font-size: 10px; color: var(--neon); font-weight: bold; }

        /* M3: Dial Logic */
        .dial-container { position: relative; width: 260px; height: 260px; margin-top: 30px; }
        #dial { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(#333, #111); border: 8px solid #444; position: relative; transition: transform 0.1s; cursor: grab; }
        .dial-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: #222; border-radius: 50%; border: 2px solid #444; display: flex; align-items: center; justify-content: center; color: var(--gold); font-weight: bold; }

        .btn { background: var(--gold); color: black; border: none; padding: 12px 35px; border-radius: 50px; font-weight: bold; cursor: pointer; font-family: 'Cinzel'; margin-top: 30px; }
        .btn:disabled { background: #444; color: #888; }
    </style>
</head>
<body>

<div class="game-wrap">
    <div id="m1" class="mission active">
        <h1>Mission 1: çƒ­åŠ›æœå¯»</h1>
        <div class="slot-tracker">
            <span style="font-size: 0.7rem; color: var(--gold); font-weight: bold;">ğŸ”¥ é™é‡åé¢: <span id="m1-slots">100</span> / 100 LEFT</span>
            <div class="progress-bg"><div id="m1-bar" class="progress-fill" style="width: 100%;"></div></div>
        </div>
        <p class="desc">æ‰¾åˆ° 3 ä¸ªå‰ç¥¥ç‰©å³é¢†é™é‡ Free Spins</p>
        
        <div id="scanner-box" onmousemove="handleScan(event)" ontouchmove="handleScan(event)">
            <div id="torch"></div>
            <img src="https://ricobr.ft-crm.com/media-api/serve/9cc65950-210b-4f56-995f-e4a94dd1d82c_2.png" class="mascot-target" style="top: 30px; left: 20px; width: 60px;" onclick="findMascot(this)">
            <img src="https://ricobr.ft-crm.com/media-api/serve/9cc65950-210b-4f56-995f-e4a94dd1d82c_2.png" class="mascot-target" style="top: 260px; left: 150px; width: 35px;" onclick="findMascot(this)">
            <img src="https://ricobr.ft-crm.com/media-api/serve/9cc65950-210b-4f56-995f-e4a94dd1d82c_2.png" class="mascot-target" style="top: 180px; left: 300px; width: 50px;" onclick="findMascot(this)">
        </div>
        <p id="m1-count" style="color:var(--gold); margin-top:15px;">å·²æ‰¾åˆ°: 0/3</p>
    </div>

    <div id="m2" class="mission">
        <h1>Mission 2: é€»è¾‘ç”µè·¯</h1>
        <p class="desc">æ—‹è½¬ç®¡é“å°† INLET è¿æ¥åˆ° EXIT</p>
        <div style="position:relative;">
            <div class="entry" style="top:-15px; left:10px;">INLET â–¼</div>
            <div class="pipe-grid" id="pipeGrid"></div>
            <div class="exit" style="bottom:-15px; right:10px;">EXIT â–²</div>
        </div>
        <button class="btn" id="m2-btn" disabled onclick="win('CONNECT-PIPE-MASTER')">ç³»ç»Ÿæ¿€æ´»</button>
    </div>

    <div id="m3" class="mission">
        <h1>Mission 3: é‡‘åº“å¯†ç </h1>
        <p class="desc">å¯»æ‰¾ 3 ä¸ªæ­£ç¡®å¯†ç ä½ç½®</p>
        <div class="dial-container">
            <div id="dial" onmousedown="startRotate(event)" ontouchstart="startRotate(event)">
                <div class="dial-center" id="dialDisplay">0</div>
            </div>
        </div>
        <p id="vault-status" style="margin-top:20px; color:var(--gold)">è¿›åº¦: 0 / 3</p>
    </div>

    <div style="margin-top:20px; opacity:0.1; font-size:10px;">
        <span onclick="switchM('m1')">M1</span> | <span onclick="switchM('m2')">M2</span> | <span onclick="switchM('m3')">M3</span>
    </div>
</div>

<script>
    // 100 UNIQUE VOUCHERS POOL
    const VOUCHER_POOL = Array.from({length: 100}, (_, i) => `RICO-FS-${2000 + i}`);
    
    let m1Count = 0;
    let m1State = { claimed: false, index: 0 };

    window.onload = function() {
        // Load Slot Count & Claim Status
        m1State.index = parseInt(localStorage.getItem('rico_m1_idx') || "0");
        m1State.claimed = localStorage.getItem('rico_m1_claimed') === 'true';
        updateSlotUI();
        
        if(m1State.claimed) {
            const savedCode = localStorage.getItem('rico_m1_code');
            document.getElementById('m1-count').innerHTML = `å¥–åŠ±å·²é¢†å–: <b style="color:var(--neon)">${savedCode}</b>`;
        }
    };

    function updateSlotUI() {
        const remaining = 100 - m1State.index;
        document.getElementById('m1-slots').innerText = remaining;
        document.getElementById('m1-bar').style.width = remaining + "%";
        if(remaining <= 0 && !m1State.claimed) {
            document.querySelector('.desc').innerText = "âŒ æŠ±æ­‰ï¼Œä»Šæ—¥åé¢å·²æŠ¢å…‰";
            document.getElementById('scanner-box').style.pointerEvents = 'none';
            document.getElementById('scanner-box').style.opacity = '0.3';
        }
    }

    function switchM(id) {
        document.querySelectorAll('.mission').forEach(m => m.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'm2') initPipeGame();
    }

    function win(code) {
        alert("ä»»åŠ¡å®Œæˆï¼æ‚¨çš„å¥–åŠ±ä»£ç : " + code);
        // Do not reload so player can see code
    }

    // --- M1: Thermal Search Logic + SLOT CLAIM ---
    function handleScan(e) {
        if(m1State.claimed) return;
        const torch = document.getElementById('torch');
        const box = document.getElementById('scanner-box').getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - box.left;
        const y = (e.clientY || e.touches[0].clientY) - box.top;
        torch.style.left = x + 'px';
        torch.style.top = y + 'px';
        document.querySelectorAll('.mascot-target').forEach(m => {
            const mx = parseInt(m.style.left) + 25;
            const my = parseInt(m.style.top) + 25;
            const dist = Math.sqrt(Math.pow(x - mx, 2) + Math.pow(y - my, 2));
            if(dist < 80) m.style.opacity = (80 - dist) / 80;
            else if(!m.classList.contains('found')) m.style.opacity = 0;
        });
    }

    function findMascot(el) {
        if(m1State.claimed || 100 - m1State.index <= 0) return;
        if(!el.classList.contains('found')) {
            el.classList.add('found'); 
            m1Count++;
            document.getElementById('m1-count').innerText = `å·²æ‰¾åˆ°: ${m1Count}/3`;
            if(m1Count === 3) claimM1();
        }
    }

    function claimM1() {
        const code = VOUCHER_POOL[m1State.index];
        m1State.index++;
        m1State.claimed = true;
        
        localStorage.setItem('rico_m1_idx', m1State.index);
        localStorage.setItem('rico_m1_claimed', 'true');
        localStorage.setItem('rico_m1_code', code);
        
        updateSlotUI();
        document.getElementById('m1-count').innerHTML = `ğŸ‰ æŠ¢åˆ°åé¢ï¼å”¯ä¸€ç : <b style="color:var(--neon)">${code}</b>`;
        alert("Mission 1 Complete! Unique Code: " + code);
    }

    // --- M2: Logic Pipe Games (UNTOUCHED) ---
    const gridDim = 4;
    let pipes = [];
    function initPipeGame() {
        const grid = document.getElementById('pipeGrid'); grid.innerHTML = ''; pipes = [];
        for(let i=0; i<gridDim*gridDim; i++) {
            const type = Math.random() > 0.5 ? 1 : 0;
            const rot = Math.floor(Math.random()*4) * 90;
            const cell = document.createElement('div');
            cell.className = 'pipe-cell';
            cell.innerHTML = `<svg class="pipe-svg" viewBox="0 0 100 100">${type===0 ? '<path d="M50 0 L50 100" />' : '<path d="M50 0 Q50 50 100 50" />'}</svg>`;
            cell.style.transform = `rotate(${rot}deg)`;
            const pObj = { el: cell, type, rot, x: i%gridDim, y: Math.floor(i/gridDim) };
            cell.onclick = () => { pObj.rot = (pObj.rot+90)%360; cell.style.transform=`rotate(${pObj.rot}deg)`; checkPath(); };
            pipes.push(pObj); grid.appendChild(cell);
        }
        checkPath();
    }
    function getConns(p) {
        const r = p.rot;
        if(p.type === 0) return r%180===0?['N','S']:['E','W'];
        if(r===0)return['N','E']; if(r===90)return['E','S']; if(r===180)return['S','W']; return['W','N'];
    }
    function checkPath() {
        document.querySelectorAll('.pipe-cell').forEach(c => c.classList.remove('active-pipe'));
        let active = new Set(); let q = [];
        if(getConns(pipes[0]).includes('N')) q.push(0);
        while(q.length > 0) {
            let i = q.shift(); if(active.has(i)) continue; active.add(i);
            pipes[i].el.classList.add('active-pipe');
            const c = getConns(pipes[i]);
            const n = {N:[pipes[i].x, pipes[i].y-1,'S'],S:[pipes[i].x, pipes[i].y+1,'N'],E:[pipes[i].x+1, pipes[i].y,'W'],W:[pipes[i].x-1, pipes[i].y,'E']};
            for(let d in n) {
                if(c.includes(d)){
                    const [nx,ny,need]=n[d];
                    if(nx>=0 && nx<4 && ny>=0 && ny<4){
                        const ni = ny*4+nx; if(getConns(pipes[ni]).includes(need)) q.push(ni);
                    }
                }
            }
        }
        document.getElementById('m2-btn').disabled = !(active.has(15) && getConns(pipes[15]).includes('S'));
    }

    // --- M3: Vault Dial Games (UNTOUCHED) ---
    let targetCodes = [45, 120, 280]; let currentStep = 0;
    function startRotate(e) {
        const dial = document.getElementById('dial'); const rect = dial.getBoundingClientRect();
        const center = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
        const move = (me) => {
            const cx = me.clientX || me.touches[0].clientX; const cy = me.clientY || me.touches[0].clientY;
            const angle = Math.atan2(cy-center.y, cx-center.x) * 180 / Math.PI + 90;
            let rot = (angle + 360) % 360; dial.style.transform = `rotate(${rot}deg)`;
            const disp = Math.floor(rot); const el = document.getElementById('dialDisplay');
            el.innerText = disp; el.style.color = Math.abs(disp - targetCodes[currentStep]) < 5 ? 'var(--neon)' : 'var(--gold)';
        };
        const stop = () => {
            window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', stop);
            window.removeEventListener('touchmove', move); window.removeEventListener('touchend', stop);
            const r = parseInt(document.getElementById('dialDisplay').innerText);
            if(Math.abs(r - targetCodes[currentStep]) < 5) {
                currentStep++; document.getElementById('vault-status').innerText = `è¿›åº¦: ${currentStep} / 3`;
                if(currentStep === 3) win('VAULT-BREACH-99');
            }
        };
        window.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);
        window.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', stop);
    }
</script>

</body>
</html>
