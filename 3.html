<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rico.bet VIP Expert Missions</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --gold:#ffd166;
      --dark:#070504;
      --panel:#0f0b08;
      --neon:#22d3ee;
      --danger:#ef4444;
      --muted:#9ca3af;
      --glass: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      background:
        radial-gradient(1200px 800px at 50% -10%, rgba(255,209,102,.08), transparent 60%),
        radial-gradient(900px 700px at 20% 110%, rgba(34,211,238,.08), transparent 55%),
        var(--dark);
      color:#fff;
      font-family:'Orbitron', system-ui, sans-serif;
      padding: 18px 12px;
    }

    /* Main frame */
    .game-wrap{
      max-width: 460px;
      width: 100%;
      border-radius: 22px;
      padding: 18px;
      position: relative;
      background:
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)),
        var(--panel);
      border: 1px solid rgba(255,209,102,.35);
      box-shadow:
        0 30px 120px rgba(0,0,0,.65),
        0 0 0 1px rgba(255,209,102,.08) inset;
      overflow:hidden;
    }

    /* Animated border glow */
    .game-wrap::before{
      content:"";
      position:absolute; inset:-2px;
      border-radius: 24px;
      background: conic-gradient(from 180deg,
        rgba(255,209,102,.0),
        rgba(255,209,102,.25),
        rgba(34,211,238,.22),
        rgba(255,209,102,.0)
      );
      filter: blur(16px);
      opacity:.55;
      animation: spinGlow 8s linear infinite;
      pointer-events:none;
    }
    @keyframes spinGlow { to { transform: rotate(360deg); } }

    /* Subtle floating particles */
    .particles{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:.25;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,209,102,.25) 0 2px, transparent 3px),
        radial-gradient(circle at 70% 20%, rgba(34,211,238,.22) 0 2px, transparent 3px),
        radial-gradient(circle at 85% 60%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 35% 75%, rgba(255,209,102,.16) 0 2px, transparent 3px);
      animation: floatDust 6s ease-in-out infinite alternate;
    }
    @keyframes floatDust{
      from{ transform: translateY(0px); }
      to{ transform: translateY(-10px); }
    }

    h1{
      font-family:'Cinzel';
      color: var(--gold);
      text-align:center;
      font-size: 1.15rem;
      margin: 6px 0 8px;
      letter-spacing: .6px;
      text-shadow: 0 0 16px rgba(255,209,102,.18);
      position:relative;
      z-index:1;
    }

    .desc{
      font-size: 0.78rem;
      color: #b3b3b3;
      text-align:center;
      margin: 0 0 12px;
      position:relative;
      z-index:1;
      line-height:1.35;
    }
    .desc b{ color: var(--gold); }

    /* Gate panel */
    .drop-panel{
      width:100%;
      padding: 12px 12px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(600px 220px at 50% -20%, rgba(255,209,102,.14), transparent 60%),
        rgba(0,0,0,.28);
      box-shadow: 0 16px 60px rgba(0,0,0,.45);
      position:relative;
      z-index:1;
    }
    .drop-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .drop-kv{
      font-size:12px;
      color:#ddd;
    }
    .drop-kv b{ color: var(--gold); }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      user-select:none;
      white-space:nowrap;
    }
    .badge.live{
      border-color: rgba(34,211,238,.35);
      background: rgba(34,211,238,.12);
      color: #d6fbff;
    }
    .badge.closed{
      border-color: rgba(255,255,255,.14);
      color: #e7e7e7;
    }
    .badge.full{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
      color:#ffd1d1;
    }

    .countdown{
      margin-top:10px;
      text-align:center;
      font-family:'Cinzel';
      color: var(--gold);
      letter-spacing:.8px;
      font-size: 14px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px dashed rgba(255,209,102,.45);
      background: rgba(255,255,255,.03);
    }
    .tiny{
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted);
      text-align:center;
    }

    /* Scanner */
    #scanner-box{
      position: relative;
      width: 100%;
      height: 350px;
      margin-top: 14px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 400px at 50% -20%, rgba(34,211,238,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.25)),
        #040404;
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      z-index:1;
    }

    /* subtle scanline animation */
    #scanner-box::after{
      content:"";
      position:absolute; left:0; right:0; top:-40%;
      height: 40%;
      background: linear-gradient(to bottom, transparent, rgba(34,211,238,.08), transparent);
      animation: scanline 3.2s linear infinite;
      pointer-events:none;
      opacity:.45;
    }
    @keyframes scanline{
      to { transform: translateY(420px); }
    }

    #torch{
      position:absolute;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(255,209,102,0.30) 0%, transparent 72%);
      border-radius:50%;
      transform: translate(-50%, -50%);
      pointer-events:none;
      z-index: 8;
      opacity: 1;
      transition: opacity .15s ease;
      filter: drop-shadow(0 0 10px rgba(255,209,102,.15));
    }
    #torch.hidden{ opacity:0; }

    .mascot-target{
      position:absolute;
      opacity: 0;
      transition: opacity .25s ease;
      cursor:pointer;
      z-index: 6;
      filter: drop-shadow(0 0 0 rgba(0,0,0,0));
    }
    .mascot-target.found{
      opacity: 1 !important;
      filter: drop-shadow(0 0 14px rgba(255,209,102,.55));
      pointer-events:none;
    }

    /* HARD LOCK OVERLAY */
    .lock-overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 50;
      background:
        radial-gradient(800px 340px at 50% 20%, rgba(0,0,0,.20), rgba(0,0,0,.82)),
        rgba(0,0,0,.55);
      pointer-events: all; /* IMPORTANT: captures mouse/touch */
      backdrop-filter: blur(2px);
    }
    .lock-overlay.show{ display:flex; }

    .lock-card{
      width: 100%;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      padding: 16px 14px;
      box-shadow:
        0 24px 90px rgba(0,0,0,.65),
        0 0 0 1px rgba(255,255,255,.06) inset;
      position:relative;
      overflow:hidden;
    }
    .lock-card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(400px 140px at 50% 0%, rgba(255,209,102,.20), transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .lock-title{
      font-family:'Cinzel';
      font-size: 16px;
      color: var(--gold);
      text-align:center;
      margin-bottom: 6px;
      letter-spacing:.7px;
      position:relative;
      z-index:1;
      text-shadow: 0 0 18px rgba(255,209,102,.18);
    }
    .lock-msg{
      font-size: 12px;
      color:#ddd;
      text-align:center;
      line-height: 1.35;
      position:relative;
      z-index:1;
    }
    .lock-msg b{ color: var(--gold); }

    .lock-pill{
      margin: 10px auto 0;
      width: fit-content;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color:#f0f0f0;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      position:relative;
      z-index:1;
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity:.95; }
      50%{ transform: scale(1.02); opacity:1; }
    }

    /* Found */
    #m1-count{
      margin-top: 14px;
      color: var(--gold);
      text-align:center;
      font-family:'Cinzel';
      letter-spacing:.7px;
      z-index:1;
      position:relative;
    }

    /* Modal */
    .modal-back { position: fixed; inset: 0; background: rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; padding: 18px; z-index: 9999; }
    .modal-back.show { display:flex; }
    .modal { width: min(420px, 100%); background: #0d0d0d; border: 1px solid rgba(255,255,255,.12); border-radius: 16px; box-shadow: 0 25px 80px rgba(0,0,0,.65); overflow:hidden; }
    .modal-top{ padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,.10); display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .modal-title{ font-family:'Cinzel'; color: var(--gold); font-size: 14px; letter-spacing:.5px; }
    .modal-x{ border:none; cursor:pointer; width: 36px; height: 36px; border-radius: 12px; background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.14); color:white; }
    .modal-body{ padding: 14px; color: #ddd; font-size: 13px; line-height: 1.4; }
    .modal-actions{ padding: 0 14px 14px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; }
    .modal-ok{ background: var(--gold); color:#000; border:none; padding: 10px 16px; border-radius: 12px; cursor:pointer; font-family:'Cinzel'; font-weight:bold; }
    .danger-tag{ display:inline-flex; align-items:center; gap:8px; padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(239,68,68,.35); background: rgba(239,68,68,.12); color: #ffd1d1; margin-top: 10px; }
    .code-box{ margin-top: 10px; user-select: all; padding: 10px 12px; border-radius: 12px; border: 1px dashed rgba(255,209,102,.55); color: var(--gold); background: rgba(255,255,255,.05); text-align:center; font-family:'Cinzel'; letter-spacing:.6px; }
    .small{ font-size:12px; color:#aaa; margin-top:10px; }
  </style>
</head>
<body>

<div class="game-wrap">
  <div class="particles"></div>

  <h1>MISSION 1: THERMAL HUNT</h1>
  <p class="desc">
    Reward gates open <b>5 times daily</b> (UTC-3): <b>12:00 AM</b>, <b>9:00 AM</b>, <b>1:00 PM</b>, <b>5:00 PM</b>, <b>9:00 PM</b><br>
    Each gate stays open for <b>30 minutes</b>.
  </p>

  <div class="drop-panel">
    <div class="drop-top">
      <div class="drop-kv">Gate: <b id="gateLabel">—</b></div>
      <div id="dropBadge" class="badge closed">● Gate Closed</div>
    </div>
    <div class="countdown" id="dropCountdown">Loading gate schedule…</div>
    <div class="tiny" id="dropTiny">Gate time: — (UTC-3)</div>
  </div>

  <div id="scanner-box" onmousemove="handleScan(event)" ontouchmove="handleScan(event)">
    <div id="torch" class="hidden"></div>

    <!-- HARD LOCK overlay -->
    <div class="lock-overlay show" id="m1LockOverlay">
      <div class="lock-card">
        <div class="lock-title" id="lockTitle">GATE CLOSED</div>
        <div class="lock-msg" id="lockMsg">Gate opens in <b>--:--:--</b>. Come back on time to grab the reward.</div>
        <div class="lock-pill" id="lockPill">LOCKED</div>
      </div>
    </div>

    <img src="https://ricobr.ft-crm.com/media-api/serve/9cc65950-210b-4f56-995f-e4a94dd1d82c_2.png"
         class="mascot-target" style="top: 34px; left: 22px; width: 64px;" onclick="findMascot(this)">
    <img src="https://ricobr.ft-crm.com/media-api/serve/9cc65950-210b-4f56-995f-e4a94dd1d82c_2.png"
         class="mascot-target" style="top: 262px; left: 160px; width: 38px;" onclick="findMascot(this)">
    <img src="https://ricobr.ft-crm.com/media-api/serve/9cc65950-210b-4f56-995f-e4a94dd1d82c_2.png"
         class="mascot-target" style="top: 182px; left: 312px; width: 54px;" onclick="findMascot(this)">
  </div>

  <p id="m1-count">Found: 0/3</p>
</div>

<div class="modal-back" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-top">
      <div class="modal-title" id="modalTitle">Notice</div>
      <button class="modal-x" onclick="hideModal()">✕</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-actions">
      <button class="modal-ok" onclick="hideModal()">OK</button>
    </div>
  </div>
</div>

<script>
  /***********************
   * CONFIG
   ***********************/
  const API_URL = "https://script.google.com/macros/s/AKfycbznd7bbyWz675zI6w6sA-JtXYP0Op83Ilz0eXBVwZk5fosvClc7dKBEairYqxpCrdVfJQ/exec";
  const MISSION = "M1";

  // Gate schedule in UTC-3 (24h)
  const GATES = [
    { h: 0,  m: 0, label: "12:00 AM" },
    { h: 9,  m: 0, label: "9:00 AM"  },
    { h: 13, m: 0, label: "1:00 PM"  },
    { h: 17, m: 0, label: "5:00 PM"  },
    { h: 21, m: 0, label: "9:00 PM"  },
  ];
  const OPEN_WINDOW_MINUTES = 30;
  const UTC3_OFFSET_MIN = -180; // UTC-3

  /***********************
   * Modal
   ***********************/
  function showModal(title, html){
    document.getElementById('modalTitle').innerText = title || "Notice";
    document.getElementById('modalBody').innerHTML = html || "";
    document.getElementById('modalBack').classList.add('show');
  }
  function hideModal(){
    document.getElementById('modalBack').classList.remove('show');
  }

  /***********************
   * ClaimKey
   ***********************/
  function getClaimKey() {
    const k = localStorage.getItem("rico_claimKey");
    if (k) return k;
    const newK = "CK-" + Math.random().toString(36).slice(2) + "-" + Date.now();
    localStorage.setItem("rico_claimKey", newK);
    return newK;
  }

  /***********************
   * API
   ***********************/
  async function apiClaim() {
    const claimKey = getClaimKey();
    const body = new URLSearchParams({ action: "claim", mission: MISSION, claimKey });
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body
    });
    return res.json();
  }

  /***********************
   * Gate time (UI only)
   ***********************/
  function nowUtc3Date(){
    return new Date(Date.now() + UTC3_OFFSET_MIN * 60 * 1000);
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function formatHMS(sec){
    sec = Math.max(0, Math.floor(sec));
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  }

  function computeGateState(){
    const d = nowUtc3Date();
    const Y = d.getUTCFullYear();
    const Mo = d.getUTCMonth();
    const Da = d.getUTCDate();

    const openMs = OPEN_WINDOW_MINUTES * 60 * 1000;
    const candidates = GATES.map(g => {
      const start = new Date(Date.UTC(Y, Mo, Da, g.h, g.m, 0));
      const end = new Date(start.getTime() + openMs);
      return { ...g, start, end };
    });

    const now = new Date(Date.UTC(Y, Mo, Da, d.getUTCHours(), d.getUTCMinutes(), d.getUTCSeconds()));

    let currentGate = null;
    for (const c of candidates){
      if (now >= c.start && now < c.end){ currentGate = c; break; }
    }

    let nextGate = candidates.find(c => now < c.start);
    if (!nextGate){
      const tomorrow = new Date(Date.UTC(Y, Mo, Da + 1, 0, 0, 0));
      const tY = tomorrow.getUTCFullYear();
      const tMo = tomorrow.getUTCMonth();
      const tDa = tomorrow.getUTCDate();
      const g0 = GATES[0];
      nextGate = {
        ...g0,
        start: new Date(Date.UTC(tY, tMo, tDa, g0.h, g0.m, 0)),
        end: new Date(Date.UTC(tY, tMo, tDa, g0.h, g0.m, 0) + openMs)
      };
    }

    if (currentGate){
      return {
        state: "OPEN",
        gateLabel: currentGate.label,
        closesInSec: (currentGate.end.getTime() - now.getTime()) / 1000,
        opensInSec: 0
      };
    }

    return {
      state: "CLOSED",
      gateLabel: nextGate.label,
      closesInSec: 0,
      opensInSec: (nextGate.start.getTime() - now.getTime()) / 1000
    };
  }

  /***********************
   * HARD lock/unlock (fixes your issue)
   ***********************/
  let gateState = "CLOSED";

  function setBadge(state){
    const badge = document.getElementById("dropBadge");
    badge.className = "badge";
    if (state === "OPEN"){
      badge.classList.add("live");
      badge.innerText = "● Gate LIVE";
    } else {
      badge.classList.add("closed");
      badge.innerText = "● Gate Closed";
    }
  }

  function lockMission1UI(msgHTML){
    gateState = "CLOSED";
    document.getElementById('m1LockOverlay').classList.add('show');
    document.getElementById('torch').classList.add('hidden');

    // IMPORTANT: stop all mascot interactions
    document.querySelectorAll('.mascot-target').forEach(m => m.style.pointerEvents = "none");

    // also force-hide all non-found mascots (so they don't glow)
    document.querySelectorAll('.mascot-target:not(.found)').forEach(m => m.style.opacity = 0);

    if (msgHTML) document.getElementById('lockMsg').innerHTML = msgHTML;
  }

  function unlockMission1UI(){
    gateState = "OPEN";
    document.getElementById('m1LockOverlay').classList.remove('show');
    document.getElementById('torch').classList.remove('hidden');

    document.querySelectorAll('.mascot-target').forEach(m => {
      if(!m.classList.contains('found')) m.style.pointerEvents = "auto";
    });
  }

  function renderGateUI(){
    const g = computeGateState();

    document.getElementById("gateLabel").innerText = g.gateLabel;

    const d = nowUtc3Date();
    const t = `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())} ${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())}`;
    document.getElementById("dropTiny").innerText = `Gate time: ${t} (UTC-3)`;

    if (g.state === "OPEN"){
      setBadge("OPEN");
      document.getElementById("dropCountdown").innerText = `GATE IS LIVE — CLOSES IN ${formatHMS(g.closesInSec)}`;
      unlockMission1UI();
    } else {
      setBadge("CLOSED");
      document.getElementById("dropCountdown").innerText = `GATE OPENS IN ${formatHMS(g.opensInSec)}`;
      lockMission1UI(`Gate opens in <b>${formatHMS(g.opensInSec)}</b>.<br>Come back on time to grab the reward.`);
    }
  }

  /***********************
   * Scanner mechanics (BLOCK when locked)
   ***********************/
  let m1Count = 0;

  function handleScan(e) {
    // ✅ HARD BLOCK: no scan updates when gate closed
    if (gateState !== "OPEN") return;

    const torch = document.getElementById('torch');
    const box = document.getElementById('scanner-box').getBoundingClientRect();
    const x = (e.clientX || (e.touches && e.touches[0].clientX)) - box.left;
    const y = (e.clientY || (e.touches && e.touches[0].clientY)) - box.top;

    torch.style.left = x + 'px';
    torch.style.top  = y + 'px';

    document.querySelectorAll('.mascot-target').forEach(m => {
      if(m.classList.contains('found')) return;

      const mx = parseInt(m.style.left) + 25;
      const my = parseInt(m.style.top)  + 25;
      const dist = Math.sqrt(Math.pow(x - mx, 2) + Math.pow(y - my, 2));
      if(dist < 80) m.style.opacity = (80 - dist) / 80;
      else m.style.opacity = 0;
    });
  }

  function resetM1(){
    m1Count = 0;
    document.getElementById('m1-count').innerText = `Found: 0/3`;
    document.querySelectorAll('.mascot-target').forEach(m => {
      m.classList.remove('found');
      m.style.opacity = 0;
      m.style.pointerEvents = "none";
    });
  }

  async function winMission1Claim(){
    // Your requested popup when gate closed
    if(gateState !== "OPEN"){
      const g = computeGateState();
      showModal("Gate Closed", `Gate open in <b>${formatHMS(g.opensInSec)}</b><div class="danger-tag">Please come back during the next gate.</div>`);
      resetM1();
      renderGateUI();
      return;
    }

    showModal("Checking…", `Verifying availability…`);

    const r = await apiClaim();

    if(!r.ok){
      if(r.waveClosed || r.gateClosed){
        const g = computeGateState();
        showModal("Gate Closed", `Gate open in <b>${formatHMS(g.opensInSec)}</b><div class="danger-tag">Please come back during the next gate.</div>`);
        resetM1();
        renderGateUI();
        return;
      }
      if(r.waveFull || r.gateFull){
        const g = computeGateState();
        showModal("FULLY REDEEMED", `This gate is fully redeemed.<div class="danger-tag">Next gate in <b>${formatHMS(g.opensInSec)}</b></div>`);
        lockMission1UI(`Next gate opens in <b>${formatHMS(g.opensInSec)}</b>.`);
        resetM1();
        return;
      }
      if(r.soldOut){
        showModal("Sold Out", `No vouchers left.<div class="danger-tag">Please contact support.</div>`);
        lockMission1UI(`No vouchers left for this event.`);
        resetM1();
        return;
      }
      showModal("Error", `Cannot claim right now.<div class="danger-tag">${(r.error || "unknown error")}</div>`);
      resetM1();
      return;
    }

    showModal(
      r.alreadyClaimed ? "Already Claimed" : "Mission 1 Completed ✅",
      `Your Voucher Code:
       <div class="code-box">${r.voucher}</div>
       <div class="small">Use this code to redeem your reward.</div>`
    );

    lockMission1UI(`You have already claimed for this gate.`);
  }

  function findMascot(el) {
    // ✅ HARD BLOCK
    if (gateState !== "OPEN") return;

    if(!el.classList.contains('found')) {
      el.classList.add('found');
      el.style.opacity = 1;
      m1Count++;
      document.getElementById('m1-count').innerText = `Found: ${m1Count}/3`;
      if(m1Count === 3) setTimeout(() => winMission1Claim(), 450);
    }
  }

  // Smooth countdown
  setInterval(renderGateUI, 1000);
  renderGateUI();
</script>
</body>
</html>
