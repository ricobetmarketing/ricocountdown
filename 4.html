<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rico.bet VIP Expert Missions</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root { --gold: #ffd166; --dark: #0b0604; --neon: #22d3ee; --danger:#ef4444; }
    body { background: var(--dark); color: white; font-family: 'Orbitron', sans-serif; margin: 0; display: flex; justify-content: center; }

    .game-wrap { max-width: 450px; width: 100%; margin: 20px auto; padding: 20px; border: 2px solid var(--gold); border-radius: 20px; background: #111; min-height: 600px; display: flex; flex-direction: column; }
    .mission { display: none; flex-direction: column; align-items: center; flex: 1; }
    .active { display: flex; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    h1 { font-family: 'Cinzel'; color: var(--gold); font-size: 1.3rem; text-shadow: 0 0 10px rgba(255,209,102,0.3); }
    .desc { font-size: 0.8rem; color: #888; margin-bottom: 20px; text-align: center; }

    /* --- M1 scanner (UNCHANGED) --- */
    #scanner-box { position: relative; width: 100%; height: 350px; background: #000; border-radius: 15px; overflow: hidden; cursor: none; border: 1px solid #333; }
    #torch { position: absolute; width: 140px; height: 140px; background: radial-gradient(circle, rgba(255,209,102,0.25) 0%, transparent 70%); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 10; }
    .mascot-target { position: absolute; opacity: 0; transition: opacity 0.3s; cursor: pointer; }
    .mascot-target.found { opacity: 1 !important; filter: drop-shadow(0 0 10px var(--gold)); pointer-events: none; }

    /* M1 slots UI */
    .m1-slots {
      width: 100%;
      margin-top: 12px;
      padding: 12px;
      border: 1px solid #222;
      background: #0b0b0b;
      border-radius: 12px;
    }
    .m1-slots .top {
      display:flex; justify-content:space-between; gap:10px;
      font-size: 12px; color:#bbb; align-items:center; flex-wrap:wrap;
    }
    .m1-slots .top b { color: var(--gold); }
    .m1-bar { height: 10px; margin-top: 8px; border-radius: 999px; background: #222; overflow:hidden; border: 1px solid #333; }
    .m1-bar i { display:block; height:100%; width:0%; background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(255,209,102,.95)); transition: width .4s ease; }
    .m1-locked-badge{
      display:none; margin-top:10px; font-size: 12px; color: #ffd1d1;
      background: rgba(239,68,68,.12); border: 1px solid rgba(239,68,68,.35);
      padding: 8px 10px; border-radius: 12px; width: 100%; text-align:center;
    }

    /* --- M2 pipe game (UNCHANGED) --- */
    .pipe-grid { display: grid; grid-template-columns: repeat(4, 80px); gap: 10px; padding: 15px; background: #050505; border-radius: 10px; border: 1px solid #222; }
    .pipe-cell { width: 80px; height: 80px; background: #1a1a1a; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: 0.2s; border: 1px solid #333; }
    .pipe-svg { width: 70%; height: 70%; stroke: #444; stroke-width: 12; fill: none; transition: 0.4s; stroke-linecap: round; }
    .active-pipe .pipe-svg { stroke: var(--neon); filter: drop-shadow(0 0 8px var(--neon)); }
    .entry, .exit { position: absolute; font-size: 10px; color: var(--neon); font-weight: bold; }

    /* --- M3 vault dial (UNCHANGED) --- */
    .dial-container { position: relative; width: 260px; height: 260px; margin-top: 30px; }
    #dial { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(#333, #111); border: 8px solid #444; position: relative; transition: transform 0.1s; cursor: grab; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    #dial::after { content: ''; position: absolute; top: 10px; left: 50%; width: 6px; height: 20px; background: var(--gold); transform: translateX(-50%); }
    .dial-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: #222; border-radius: 50%; border: 2px solid #444; display: flex; align-items: center; justify-content: center; color: var(--gold); font-weight: bold; }
    .indicator { width: 4px; height: 15px; background: var(--neon); margin-bottom: 5px; }

    .btn { background: var(--gold); color: black; border: none; padding: 12px 35px; border-radius: 50px; font-weight: bold; cursor: pointer; font-family: 'Cinzel'; margin-top: 30px; }
    .btn:disabled { background: #444; color: #888; }

    /* Modal popup */
    .modal-back { position: fixed; inset: 0; background: rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; padding: 18px; z-index: 9999; }
    .modal-back.show { display:flex; }
    .modal { width: min(420px, 100%); background: #0d0d0d; border: 1px solid rgba(255,255,255,.12); border-radius: 16px; box-shadow: 0 25px 80px rgba(0,0,0,.65); overflow:hidden; }
    .modal-top{ padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,.10); display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .modal-title{ font-family:'Cinzel'; color: var(--gold); font-size: 14px; letter-spacing:.5px; }
    .modal-x{ border:none; cursor:pointer; width: 36px; height: 36px; border-radius: 12px; background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.14); color:white; }
    .modal-body{ padding: 14px; color: #ddd; font-size: 13px; line-height: 1.4; }
    .modal-actions{ padding: 0 14px 14px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; }
    .modal-ok{ background: var(--gold); color:#000; border:none; padding: 10px 16px; border-radius: 12px; cursor:pointer; font-family:'Cinzel'; font-weight:bold; }
    .danger-tag{ display:inline-flex; align-items:center; gap:8px; padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(239,68,68,.35); background: rgba(239,68,68,.12); color: #ffd1d1; margin-top: 10px; }
    .code-box{ margin-top: 10px; user-select: all; padding: 10px 12px; border-radius: 12px; border: 1px dashed rgba(255,209,102,.55); color: var(--gold); background: rgba(255,255,255,.05); text-align:center; font-family:'Cinzel'; letter-spacing:.6px; }
    .small{ font-size:12px; color:#aaa; margin-top:10px; }
  </style>
</head>
<body>

<div class="game-wrap">
  <div id="m1" class="mission active">
    <h1>Mission 1: 热力搜寻</h1>
    <p class="desc">在黑暗中找到 3 个隐藏的 Rico 吉祥物</p>

    <div id="scanner-box" onmousemove="handleScan(event)" ontouchmove="handleScan(event)">
      <div id="torch"></div>
      <img src="https://ricobr.ft-crm.com/media-api/serve/9cc65950-210b-4f56-995f-e4a94dd1d82c_2.png" class="mascot-target" style="top: 30px; left: 20px; width: 60px;" onclick="findMascot(this)">
      <img src="https://ricobr.ft-crm.com/media-api/serve/9cc65950-210b-4f56-995f-e4a94dd1d82c_2.png" class="mascot-target" style="top: 260px; left: 150px; width: 35px;" onclick="findMascot(this)">
      <img src="https://ricobr.ft-crm.com/media-api/serve/9cc65950-210b-4f56-995f-e4a94dd1d82c_2.png" class="mascot-target" style="top: 180px; left: 300px; width: 50px;" onclick="findMascot(this)">
    </div>

    <p id="m1-count" style="color:var(--gold); margin-top:15px;">已找到: 0/3</p>

    <div class="m1-slots">
      <div class="top">
        <div>Mission 1 Slots Left: <b id="m1-left">—</b>/<span id="m1-limit">—</span></div>
        <div>Used: <b id="m1-used">—</b></div>
      </div>
      <div class="m1-bar"><i id="m1-bar-fill"></i></div>
      <div class="m1-locked-badge" id="m1-locked-badge">⚠️ Slot claimed finish… Mission 1 已满额 / SOLD OUT</div>
    </div>

    <div class="small">Live update from Google Sheet (poll every 5s).</div>
  </div>

  <div id="m2" class="mission">
    <h1>Mission 2: 逻辑电路</h1>
    <p class="desc">点击旋转管道。必须将左上角蓝色入口连接到右下角出口。</p>
    <div style="position:relative;">
      <div class="entry" style="top:-15px; left:10px;">INLET ▼</div>
      <div class="pipe-grid" id="pipeGrid"></div>
      <div class="exit" style="bottom:-15px; right:10px;">EXIT ▲</div>
    </div>
    <button class="btn" id="m2-btn" disabled onclick="win('CONNECT-PIPE-MASTER')">系统激活</button>
  </div>

  <div id="m3" class="mission">
    <h1>Mission 3: 金库密码</h1>
    <p class="desc">旋转拨盘寻找 3 个正确位置。当中心数字变蓝时点击拨盘。</p>
    <div class="indicator"></div>
    <div class="dial-container">
      <div id="dial" onmousedown="startRotate(event)" ontouchstart="startRotate(event)">
        <div class="dial-center" id="dialDisplay">0</div>
      </div>
    </div>
    <p id="vault-status" style="margin-top:20px; color:var(--gold)">进度: 0 / 3</p>
  </div>

  <div style="margin-top:20px; opacity:0.15; font-size:10px;">
    <span onclick="switchM('m1')">M1</span> | <span onclick="switchM('m2')">M2</span> | <span onclick="switchM('m3')">M3</span>
  </div>
</div>

<div class="modal-back" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-top">
      <div class="modal-title" id="modalTitle">Notice</div>
      <button class="modal-x" onclick="hideModal()">✕</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-actions">
      <button class="modal-ok" onclick="hideModal()">OK</button>
    </div>
  </div>
</div>

<script>
  /***********************
   * CONFIG: Paste your Apps Script Web App URL here
   ***********************/
  const API_URL = "https://script.google.com/macros/s/AKfycbznd7bbyWz675zI6w6sA-JtXYP0Op83Ilz0eXBVwZk5fosvClc7dKBEairYqxpCrdVfJQ/exec"; // e.g. https://script.google.com/macros/s/xxxx/exec
  const MISSION = "M1";

  function switchM(id) {
    document.querySelectorAll('.mission').forEach(m => m.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (id === 'm2') initPipeGame();
    if (id === 'm1') refreshM1FromServer();
  }

  // Keep original win() for Mission 2 & 3 (unchanged)
  function win(code) {
    alert("任务完成！您的奖励代码: " + code);
    location.reload();
  }

  function showModal(title, html){
    document.getElementById('modalTitle').innerText = title || "Notice";
    document.getElementById('modalBody').innerHTML = html || "";
    document.getElementById('modalBack').classList.add('show');
  }
  function hideModal(){
    document.getElementById('modalBack').classList.remove('show');
  }

  /***********************
   * ClaimKey (1 per device/browser)
   ***********************/
  function getClaimKey() {
    const k = localStorage.getItem("rico_claimKey");
    if (k) return k;
    const newK = "CK-" + Math.random().toString(36).slice(2) + "-" + Date.now();
    localStorage.setItem("rico_claimKey", newK);
    return newK;
  }

  /***********************
   * API calls
   ***********************/
  async function apiStatus() {
    const url = `${API_URL}?action=status&mission=${encodeURIComponent(MISSION)}`;
    const res = await fetch(url, { method: "GET" });
    return res.json();
  }

  async function apiClaim() {
    const claimKey = getClaimKey();
    const body = new URLSearchParams({ action: "claim", mission: MISSION, claimKey });

    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body
    });
    return res.json();
  }

  /***********************
   * Mission 1 UI
   ***********************/
  function lockMission1UI(){
    document.getElementById('scanner-box').style.pointerEvents = "none";
    document.querySelectorAll('.mascot-target').forEach(m => m.style.pointerEvents = "none");
    document.getElementById('m1-locked-badge').style.display = "block";
  }

async function refreshM1FromServer(){
  // show quick placeholders (so user doesn't feel stuck)
  document.getElementById("m1-limit").innerText = "...";
  document.getElementById("m1-used").innerText = "...";
  document.getElementById("m1-left").innerText = "...";

  // timeout so it won't hang forever
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), 6000);

  try{
    const url = `${API_URL}?action=status&mission=${encodeURIComponent(MISSION)}&_=${Date.now()}`;
    const res = await fetch(url, { method: "GET", signal: controller.signal });
    const data = await res.json();

    if(!data.ok){
      // show fallback if backend returns error
      document.getElementById("m1-limit").innerText = "—";
      document.getElementById("m1-used").innerText = "—";
      document.getElementById("m1-left").innerText = "—";
      return;
    }

    const limit = Number(data.limit || 0);
    const used  = Number(data.used  || 0);
    const left  = Number(data.left  || 0);

    document.getElementById("m1-limit").innerText = limit;
    document.getElementById("m1-used").innerText  = used;
    document.getElementById("m1-left").innerText  = left;

    const pct = limit ? Math.round((used / limit) * 100) : 0;
    document.getElementById("m1-bar-fill").style.width = Math.min(100, pct) + "%";

    if(left <= 0){
      lockMission1UI();
    }

  } catch(e){
    // network blocked / script not public / slow
    document.getElementById("m1-limit").innerText = "—";
    document.getElementById("m1-used").innerText = "—";
    document.getElementById("m1-left").innerText = "—";
  } finally{
    clearTimeout(timer);
  }
}


  async function winMission1Limited(){
    // Live claim against Google Sheet pool
    const r = await apiClaim();

    // Sold out
    if(!r.ok && r.soldOut){
      await refreshM1FromServer();
      showModal("Slot claimed finish…", `Mission 1 SOLD OUT <div class="danger-tag">No vouchers left</div>`);
      lockMission1UI();
      return;
    }

    // Error
    if(!r.ok){
      showModal("Error", `Cannot claim right now.<div class="danger-tag">${(r.error || "unknown error")}</div>`);
      return;
    }

    await refreshM1FromServer();

    showModal(
      r.alreadyClaimed ? "Already Claimed" : "任务完成！Mission 1 Completed ✅",
      `您的奖励代码 / Voucher Code:
       <div class="code-box">${r.voucher}</div>
       <div class="small">Slots Left: <b style="color:var(--gold)">${r.left}</b> / ${r.limit}</div>`
    );

    if(r.left <= 0) lockMission1UI();
  }

  /***********************
   * M1 scanner mechanics (UNCHANGED)
   ***********************/
  let m1Count = 0;
  function handleScan(e) {
    const torch = document.getElementById('torch');
    const box = document.getElementById('scanner-box').getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - box.left;
    const y = (e.clientY || e.touches[0].clientY) - box.top;
    torch.style.left = x + 'px';
    torch.style.top = y + 'px';
    document.querySelectorAll('.mascot-target').forEach(m => {
      const dist = Math.sqrt(Math.pow(x - (parseInt(m.style.left)+25), 2) + Math.pow(y - (parseInt(m.style.top)+25), 2));
      if(dist < 80) m.style.opacity = (80 - dist) / 80;
      else if(!m.classList.contains('found')) m.style.opacity = 0;
    });
  }
  function findMascot(el) {
    if(!el.classList.contains('found')) {
      el.classList.add('found'); m1Count++;
      document.getElementById('m1-count').innerText = `已找到: ${m1Count}/3`;
      // ONLY change: when complete -> claim via Apps Script
      if(m1Count === 3) setTimeout(() => winMission1Limited(), 500);
    }
  }

  /***********************
   * M2 pipe game (UNCHANGED)
   ***********************/
  const gridDim = 4;
  let pipes = [];
  function initPipeGame() {
    const grid = document.getElementById('pipeGrid');
    grid.innerHTML = ''; pipes = [];
    for(let i=0; i<gridDim*gridDim; i++) {
      const type = Math.random() > 0.5 ? 1 : 0;
      const rot = Math.floor(Math.random()*4) * 90;
      const cell = document.createElement('div');
      cell.className = 'pipe-cell';
      cell.innerHTML = `<svg class="pipe-svg" viewBox="0 0 100 100">${type===0 ? '<path d="M50 0 L50 100" />' : '<path d="M50 0 Q50 50 100 50" />'}</svg>`;
      cell.style.transform = `rotate(${rot}deg)`;
      const pipeObj = { el: cell, type, rot, x: i%gridDim, y: Math.floor(i/gridDim) };
      cell.onclick = () => { pipeObj.rot = (pipeObj.rot + 90) % 360; cell.style.transform = `rotate(${pipeObj.rot}deg)`; checkPath(); };
      pipes.push(pipeObj);
      grid.appendChild(cell);
    }
    checkPath();
  }

  function getConnections(pipe) {
    const r = pipe.rot;
    if(pipe.type === 0) return r % 180 === 0 ? ['N','S'] : ['E','W'];
    if(r === 0) return ['N','E']; if(r === 90) return ['E','S'];
    if(r === 180) return ['S','W']; return ['W','N'];
  }

  function checkPath() {
    document.querySelectorAll('.pipe-cell').forEach(c => c.classList.remove('active-pipe'));
    let active = new Set();
    let queue = [];
    const startPipe = pipes[0];
    if(getConnections(startPipe).includes('N')) queue.push(0);

    while(queue.length > 0) {
      let idx = queue.shift();
      if(active.has(idx)) continue;
      active.add(idx);
      pipes[idx].el.classList.add('active-pipe');
      const p = pipes[idx];
      const conns = getConnections(p);
      const neighbors = { N:[p.x, p.y-1, 'S'], S:[p.x, p.y+1, 'N'], E:[p.x+1, p.y, 'W'], W:[p.x-1, p.y, 'E'] };
      for(let dir in neighbors) {
        if(conns.includes(dir)) {
          const [nx, ny, needed] = neighbors[dir];
          if(nx>=0 && nx<gridDim && ny>=0 && ny<gridDim) {
            const nIdx = ny * gridDim + nx;
            if(getConnections(pipes[nIdx]).includes(needed)) queue.push(nIdx);
          }
        }
      }
    }
    if(active.has(15) && getConnections(pipes[15]).includes('S')) {
      document.getElementById('m2-btn').disabled = false;
    } else {
      document.getElementById('m2-btn').disabled = true;
    }
  }

  /***********************
   * M3 vault dial (UNCHANGED)
   ***********************/
  let currentRotation = 0;
  let targetCodes = [45, 120, 280];
  let currentStep = 0;
  function startRotate(e) {
    const dial = document.getElementById('dial');
    const rect = dial.getBoundingClientRect();
    const center = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
    const move = (me) => {
      const clientX = me.clientX || me.touches[0].clientX;
      const clientY = me.clientY || me.touches[0].clientY;
      const angle = Math.atan2(clientY - center.y, clientX - center.x) * 180 / Math.PI + 90;
      currentRotation = (angle + 360) % 360;
      dial.style.transform = `rotate(${currentRotation}deg)`;
      const display = Math.floor(currentRotation);
      const dispEl = document.getElementById('dialDisplay');
      dispEl.innerText = display;
      if(Math.abs(display - targetCodes[currentStep]) < 5) dispEl.style.color = 'var(--neon)';
      else dispEl.style.color = 'var(--gold)';
    };
    const stop = () => {
      window.removeEventListener('mousemove', move);
      window.removeEventListener('mouseup', stop);
      window.removeEventListener('touchmove', move);
      window.removeEventListener('touchend', stop);
      if(Math.abs(Math.floor(currentRotation) - targetCodes[currentStep]) < 5) {
        currentStep++;
        document.getElementById('vault-status').innerText = `进度: ${currentStep} / 3`;
        if(currentStep === 3) win('VAULT-BREACH-99');
      }
    };
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', stop);
    window.addEventListener('touchmove', move, {passive:false});
    window.addEventListener('touchend', stop);
  }

  // Live status poll
  refreshM1FromServer();
</script>
</body>
</html>
